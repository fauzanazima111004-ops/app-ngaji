<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Ngaji - Rapor Manual Detail</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .animate-fade { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, query, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- PASTE CONFIG FIREBASE BAPAK DI SINI ---
        const firebaseConfig = {
            apiKey: "AIzaSyD0XGoRIIntaMiD-xuJUJsA38-jwiz3zxs",
            authDomain: "catatan-ngaji-app.firebaseapp.com",
            projectId: "catatan-ngaji-app",
            storageBucket: "catatan-ngaji-app.firebasestorage.app",
            messagingSenderId: "642649959513",
            appId: "1:642649959513:web:497a3120235e5ce0f61548"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.fb = { collection, addDoc, deleteDoc, updateDoc, doc, query, onSnapshot, serverTimestamp, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, orderBy };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('input');
            const [students, setStudents] = useState([]);
            const [records, setRecords] = useState([]);
            const [settings, setSettings] = useState({ tpa: '', teacher: '', logo: '' });

            // State Rapor Manual (Updated Structure)
            const [raporForm, setRaporForm] = useState({
                studentId: '',
                periode: '',
                kelas: '',
                // Bagian A: Al-Quran
                materiQuran: '', // Text bebas (e.g. "Juz 30 (An-Naba s/d An-Nas)")
                nilaiQuran: [
                    { aspek: 'Kelancaran Hafalan', nilai: '' },
                    { aspek: 'Ketepatan Tajwid', nilai: '' },
                    { aspek: 'Makhorijul Huruf', nilai: '' },
                    { aspek: 'Kekuatan Hafalan', nilai: '' }
                ],
                // Bagian B & C
                doa: [{ materi: '', nilai: '' }],
                hadits: [{ materi: '', nilai: '' }],
                catatan: ''
            });

            // Load Data
            useEffect(() => {
                window.fb.onAuthStateChanged(window.auth, (u) => {
                    setUser(u);
                    if(u) {
                        setSettings({
                            tpa: localStorage.getItem('tpaName')||'', 
                            teacher: localStorage.getItem('teacherName')||'',
                            logo: localStorage.getItem('appLogo')||''
                        });
                        window.fb.onSnapshot(window.fb.query(window.fb.collection(window.db, 'users', u.uid, 'students'), window.fb.orderBy('name')), snap => 
                            setStudents(snap.docs.map(d=>({id:d.id, ...d.data()})))
                        );
                        window.fb.onSnapshot(window.fb.query(window.fb.collection(window.db, 'users', u.uid, 'records'), window.fb.orderBy('created_at', 'desc')), snap => 
                            setRecords(snap.docs.map(d=>({id:d.id, ...d.data()})))
                        );
                    }
                });
            }, []);

            // Helper Functions
            const handleLogin = () => window.fb.signInWithPopup(window.auth, new window.fb.GoogleAuthProvider());
            const handleLogout = () => { if(confirm("Keluar?")) window.fb.signOut(window.auth); }
            const saveSettings = () => { localStorage.setItem('tpaName', settings.tpa); localStorage.setItem('teacherName', settings.teacher); localStorage.setItem('appLogo', settings.logo); alert("Tersimpan!"); }
            const handleLogoUpload = (e) => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onloadend = () => setSettings({...settings, logo: r.result}); r.readAsDataURL(f); } }

            // Data Santri
            const [newStudent, setNewStudent] = useState('');
            const saveStudent = async () => { if(newStudent){ await window.fb.addDoc(window.fb.collection(window.db, 'users', user.uid, 'students'), {name: newStudent}); setNewStudent(''); } }
            const deleteStudent = async (id) => { if(confirm("Hapus?")) await window.fb.deleteDoc(window.fb.doc(window.db, 'users', user.uid, 'students', id)); }

            // Input Harian
            const [dailyForm, setDailyForm] = useState({ studentId: '', materi: '', nilai: 'Lancar' });
            const saveDaily = async (e) => {
                e.preventDefault();
                if(!dailyForm.studentId) return alert("Pilih Santri");
                const sName = students.find(s=>s.id===dailyForm.studentId)?.name;
                await window.fb.addDoc(window.fb.collection(window.db, 'users', user.uid, 'records'), { ...dailyForm, studentName: sName, created_at: window.fb.serverTimestamp(), date: new Date().toISOString().split('T')[0] });
                alert("Tersimpan!");
            }

            // --- FUNGSI RAPOR BARU ---
            const addRow = (section) => setRaporForm({...raporForm, [section]: [...raporForm[section], { materi: '', nilai: '' }]});
            const removeRow = (section, idx) => {
                const newRows = raporForm[section].filter((_, i) => i !== idx);
                setRaporForm({...raporForm, [section]: newRows});
            }
            const updateListRow = (section, idx, field, value) => { // Untuk Doa & Hadits
                const newRows = [...raporForm[section]];
                newRows[idx][field] = value;
                setRaporForm({...raporForm, [section]: newRows});
            }
            const updateNilaiQuran = (idx, value) => { // Untuk Nilai Tajwid dll
                const newNilai = [...raporForm.nilaiQuran];
                newNilai[idx].nilai = value;
                setRaporForm({...raporForm, nilaiQuran: newNilai});
            }

            // GENERATE PDF
            const generatePDF = () => {
                if(!raporForm.studentId) return alert("Pilih Santri Dulu!");
                const doc = new window.jspdf.jsPDF();
                const studentName = students.find(s=>s.id === raporForm.studentId)?.name || "Santri";
                
                // Kop
                if(settings.logo) { try { doc.addImage(settings.logo, 'JPEG', 15, 10, 20, 20); } catch(e){} }
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16); doc.text("LAPORAN PERKEMBANGAN TAHFIDZ", 105, 20, { align: "center" });
                doc.setFontSize(12); doc.setFont("helvetica", "normal");
                doc.text(settings.tpa || "TPA / Rumah Qur'an", 105, 27, { align: "center" });
                doc.line(15, 32, 195, 32);

                // Identitas
                doc.setFontSize(10);
                doc.text(`Nama Santri : ${studentName}`, 15, 40);
                doc.text(`Kelas/Jilid : ${raporForm.kelas || '-'}`, 15, 46);
                doc.text(`Periode     : ${raporForm.periode || '-'}`, 130, 40);
                doc.text(`Penguji     : ${settings.teacher || '-'}`, 130, 46);

                let currentY = 55;

                // A. TAHFIDZ QURAN
                doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.setTextColor(0, 100, 0);
                doc.text("A. PERKEMBANGAN TAHFIDZ AL-QUR'AN", 15, currentY);
                currentY += 6;
                
                // Materi Diujikan
                doc.setFontSize(10); doc.setTextColor(0, 0, 0); doc.setFont("helvetica", "bold");
                doc.text("Materi / Surat yang Diujikan:", 15, currentY);
                doc.setFont("helvetica", "normal");
                doc.text(raporForm.materiQuran || "-", 70, currentY);
                currentY += 4;

                // Tabel Nilai Quran (Tajwid, dll)
                doc.autoTable({
                    startY: currentY,
                    head: [['Aspek Penilaian', 'Nilai / Predikat']],
                    body: raporForm.nilaiQuran.map(n => [n.aspek, n.nilai]),
                    theme: 'grid',
                    headStyles: { fillColor: [22, 163, 74] },
                    columnStyles: { 0: {cellWidth: 100}, 1: {cellWidth: 80} },
                    margin: { left: 15 }
                });
                currentY = doc.lastAutoTable.finalY + 10;

                // B. DOA
                doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.setTextColor(202, 138, 4);
                doc.text("B. HAFALAN DOA HARIAN", 15, currentY);
                currentY += 2;
                doc.autoTable({
                    startY: currentY,
                    head: [['No', 'Nama Doa', 'Nilai']],
                    body: raporForm.doa.map((r, i) => [i+1, r.materi, r.nilai]),
                    theme: 'grid',
                    headStyles: { fillColor: [234, 179, 8] },
                    columnStyles: { 0: {cellWidth: 10}, 2: {cellWidth: 50} },
                    margin: { left: 15 }
                });
                currentY = doc.lastAutoTable.finalY + 10;

                // C. HADITS
                doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.setTextColor(37, 99, 235);
                doc.text("C. HAFALAN HADITS", 15, currentY);
                currentY += 2;
                doc.autoTable({
                    startY: currentY,
                    head: [['No', 'Tema Hadits', 'Nilai']],
                    body: raporForm.hadits.map((r, i) => [i+1, r.materi, r.nilai]),
                    theme: 'grid',
                    headStyles: { fillColor: [59, 130, 246] },
                    columnStyles: { 0: {cellWidth: 10}, 2: {cellWidth: 50} },
                    margin: { left: 15 }
                });
                currentY = doc.lastAutoTable.finalY + 10;

                // CATATAN
                if(currentY > 240) { doc.addPage(); currentY = 20; }
                doc.setFillColor(245, 245, 245);
                doc.rect(15, currentY, 180, 25, 'F');
                doc.setTextColor(0,0,0);
                doc.text("Catatan Ustadz/Ustadzah:", 17, currentY + 6);
                doc.setFont("helvetica", "normal");
                doc.text(raporForm.catatan || "-", 17, currentY + 12);

                // TTD
                const signY = currentY + 40;
                doc.text("Mengetahui, Orang Tua", 15, signY);
                doc.text("( ........................... )", 15, signY + 25);
                doc.text("Guru Pembimbing", 140, signY);
                doc.text(`( ${settings.teacher || "..........................."} )`, 140, signY + 25);

                doc.save(`Rapor_${studentName}.pdf`);
            }

            // --- RENDER ---
            if(!user) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100">
                    <button onClick={handleLogin} className="bg-white p-6 rounded-xl shadow-xl flex items-center gap-3 font-bold text-blue-600 hover:scale-105 transition">
                        üîë Login Google
                    </button>
                </div>
            );

            return (
                <div className="max-w-4xl mx-auto min-h-screen bg-white shadow-2xl flex flex-col">
                    {/* Header */}
                    <div className="bg-slate-900 text-white p-4 flex justify-between items-center sticky top-0 z-50">
                        <div className="flex items-center gap-3 font-bold">
                            {settings.logo ? <img src={settings.logo} className="w-8 h-8 rounded bg-white"/> : "üìñ"} 
                            App Ngaji
                        </div>
                        <div className="flex gap-2 text-sm">
                            <button onClick={()=>setActiveTab('input')} className={`px-3 py-1 rounded ${activeTab==='input'?'bg-blue-600':''}`}>Harian</button>
                            <button onClick={()=>setActiveTab('rapor')} className={`px-3 py-1 rounded ${activeTab==='rapor'?'bg-blue-600':''}`}>Rapor Manual</button>
                            <button onClick={()=>setActiveTab('settings')} className={`px-3 py-1 rounded ${activeTab==='settings'?'bg-blue-600':''}`}>‚öôÔ∏è</button>
                            <button onClick={handleLogout} className="px-3 py-1 bg-red-600 rounded">Exit</button>
                        </div>
                    </div>

                    <div className="p-4 flex-1 bg-slate-50 overflow-y-auto">
                        
                        {/* INPUT HARIAN */}
                        {activeTab === 'input' && (
                            <div className="animate-fade">
                                <h2 className="font-bold text-lg mb-4 text-slate-700">üìù Input Harian (Simpel)</h2>
                                <form onSubmit={saveDaily} className="bg-white p-4 rounded-xl shadow border space-y-3">
                                    <select className="w-full border p-2 rounded" value={dailyForm.studentId} onChange={e=>setDailyForm({...dailyForm, studentId:e.target.value})}>
                                        <option value="">-- Pilih Santri --</option>
                                        {students.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                                    </select>
                                    <input placeholder="Materi (Contoh: Iqro 2 Hal 5)" className="w-full border p-2 rounded" value={dailyForm.materi} onChange={e=>setDailyForm({...dailyForm, materi:e.target.value})}/>
                                    <button className="w-full bg-blue-600 text-white py-2 rounded font-bold">SIMPAN</button>
                                </form>
                                <div className="mt-4 text-sm text-gray-500">
                                    <p className="mb-2 font-bold">Riwayat Terakhir:</p>
                                    {records.slice(0,5).map(r=>(<div key={r.id} className="border-b py-1 flex justify-between"><span>{r.studentName}: {r.materi}</span><span>{r.nilai}</span></div>))}
                                </div>
                            </div>
                        )}

                        {/* SETTING & SANTRI */}
                        {activeTab === 'settings' && (
                            <div className="animate-fade space-y-6">
                                <div className="bg-white p-4 rounded-xl shadow border">
                                    <h3 className="font-bold mb-2">Lembaga</h3>
                                    <input type="file" onChange={handleLogoUpload} className="mb-2 text-sm"/>
                                    <input placeholder="Nama TPA" className="w-full border p-2 rounded mb-2" value={settings.tpa} onChange={e=>setSettings({...settings, tpa:e.target.value})}/>
                                    <input placeholder="Nama Guru" className="w-full border p-2 rounded mb-2" value={settings.teacher} onChange={e=>setSettings({...settings, teacher:e.target.value})}/>
                                    <button onClick={saveSettings} className="bg-green-600 text-white px-4 py-2 rounded">Simpan</button>
                                </div>
                                <div className="bg-white p-4 rounded-xl shadow border">
                                    <h3 className="font-bold mb-2">Santri</h3>
                                    <div className="flex gap-2 mb-2"><input placeholder="Nama..." className="flex-1 border p-2 rounded" value={newStudent} onChange={e=>setNewStudent(e.target.value)}/><button onClick={saveStudent} className="bg-blue-600 text-white px-4 rounded">Tambah</button></div>
                                    {students.map(s=>(<div key={s.id} className="flex justify-between border-b py-2"><span>{s.name}</span><button onClick={()=>deleteStudent(s.id)} className="text-red-500 text-xs">Hapus</button></div>))}
                                </div>
                            </div>
                        )}

                        {/* RAPOR MANUAL (FITUR UTAMA) */}
                        {activeTab === 'rapor' && (
                            <div className="animate-fade bg-white p-6 rounded-xl shadow-lg border">
                                <h2 className="font-bold text-xl mb-6 text-center text-slate-800 border-b pb-4">üéì FORM RAPOR MANUAL</h2>
                                
                                {/* 1. Identitas */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6 bg-slate-50 p-4 rounded-lg">
                                    <div><label className="text-xs font-bold text-gray-500">SANTRI</label>
                                    <select className="w-full border p-2 rounded font-bold" value={raporForm.studentId} onChange={e=>setRaporForm({...raporForm, studentId:e.target.value})}>
                                        <option value="">- Pilih -</option>{students.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                                    </select></div>
                                    <div><label className="text-xs font-bold text-gray-500">PERIODE</label><input placeholder="Januari 2026" className="w-full border p-2 rounded" value={raporForm.periode} onChange={e=>setRaporForm({...raporForm, periode:e.target.value})}/></div>
                                    <div><label className="text-xs font-bold text-gray-500">KELAS/JILID</label><input placeholder="Iqro 3 / Tahfidz" className="w-full border p-2 rounded" value={raporForm.kelas} onChange={e=>setRaporForm({...raporForm, kelas:e.target.value})}/></div>
                                </div>

                                {/* 2. Nilai Quran Detail */}
                                <div className="mb-6 border rounded-lg overflow-hidden">
                                    <div className="bg-green-100 p-3 font-bold text-green-800">A. PENILAIAN AL-QUR'AN</div>
                                    <div className="p-4 space-y-4">
                                        <div>
                                            <label className="font-bold text-sm block mb-1">Materi / Surat yang Diujikan:</label>
                                            <textarea placeholder="Contoh: Surat An-Naba sampai Al-Insyiqaq (Lancar)" className="w-full border p-2 rounded h-16" value={raporForm.materiQuran} onChange={e=>setRaporForm({...raporForm, materiQuran:e.target.value})}/>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {raporForm.nilaiQuran.map((item, idx) => (
                                                <div key={idx} className="flex flex-col">
                                                    <label className="text-xs font-bold text-gray-500 mb-1">{item.aspek.toUpperCase()}</label>
                                                    <input placeholder="Nilai (A/B/C atau 80/90)" className="border p-2 rounded font-bold" value={item.nilai} onChange={e=>updateNilaiQuran(idx, e.target.value)}/>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* 3. Doa & Hadits */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    {/* Doa */}
                                    <div className="border rounded-lg p-3 bg-yellow-50">
                                        <div className="flex justify-between items-center mb-2"><span className="font-bold text-yellow-800">B. DOA HARIAN</span><button onClick={()=>addRow('doa')} className="text-xs bg-white border px-2 rounded">+ Baris</button></div>
                                        {raporForm.doa.map((r, i) => (
                                            <div key={i} className="flex gap-2 mb-2">
                                                <input placeholder="Nama Doa" className="flex-1 border p-1 rounded text-sm" value={r.materi} onChange={e=>updateListRow('doa', i, 'materi', e.target.value)}/>
                                                <input placeholder="Nilai" className="w-20 border p-1 rounded text-sm" value={r.nilai} onChange={e=>updateListRow('doa', i, 'nilai', e.target.value)}/>
                                                {raporForm.doa.length>1 && <button onClick={()=>removeRow('doa',i)} className="text-red-500 font-bold">x</button>}
                                            </div>
                                        ))}
                                    </div>
                                    {/* Hadits */}
                                    <div className="border rounded-lg p-3 bg-blue-50">
                                        <div className="flex justify-between items-center mb-2"><span className="font-bold text-blue-800">C. HADITS</span><button onClick={()=>addRow('hadits')} className="text-xs bg-white border px-2 rounded">+ Baris</button></div>
                                        {raporForm.hadits.map((r, i) => (
                                            <div key={i} className="flex gap-2 mb-2">
                                                <input placeholder="Tema Hadits" className="flex-1 border p-1 rounded text-sm" value={r.materi} onChange={e=>updateListRow('hadits', i, 'materi', e.target.value)}/>
                                                <input placeholder="Nilai" className="w-20 border p-1 rounded text-sm" value={r.nilai} onChange={e=>updateListRow('hadits', i, 'nilai', e.target.value)}/>
                                                {raporForm.hadits.length>1 && <button onClick={()=>removeRow('hadits',i)} className="text-red-500 font-bold">x</button>}
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* 4. Catatan */}
                                <div className="mb-6">
                                    <label className="font-bold text-sm block mb-1">Catatan Ustadz/Ustadzah:</label>
                                    <textarea className="w-full border p-2 rounded h-20" placeholder="Semangat terus nak..." value={raporForm.catatan} onChange={e=>setRaporForm({...raporForm, catatan:e.target.value})}/>
                                </div>

                                <button onClick={generatePDF} className="w-full bg-slate-800 text-white py-4 rounded-xl font-bold shadow hover:bg-slate-700 flex justify-center items-center gap-2">
                                    üñ®Ô∏è CETAK RAPOR PDF
                                </button>
                            </div>
                        )}

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
