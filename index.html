<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Ngaji - Rapor Manual</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .modal-overlay { background-color: rgba(0,0,0,0.5); }
        .animate-fade { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, query, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- PASTE CONFIG FIREBASE BAPAK DI SINI ---
        const firebaseConfig = {
            apiKey: "AIzaSyD0XGoRIIntaMiD-xuJUJsA38-jwiz3zxs",
            authDomain: "catatan-ngaji-app.firebaseapp.com",
            projectId: "catatan-ngaji-app",
            storageBucket: "catatan-ngaji-app.firebasestorage.app",
            messagingSenderId: "642649959513",
            appId: "1:642649959513:web:497a3120235e5ce0f61548"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.fb = { collection, addDoc, deleteDoc, updateDoc, doc, query, onSnapshot, serverTimestamp, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, orderBy };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- KOMPONEN UTAMA ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('input'); // input | students | rapor
            const [students, setStudents] = useState([]);
            const [records, setRecords] = useState([]);
            const [settings, setSettings] = useState({ tpa: '', teacher: '', logo: '' });

            // State untuk Rapor Manual
            const [raporMode, setRaporMode] = useState(false); // Mode buat rapor
            const [raporForm, setRaporForm] = useState({
                studentId: '',
                periode: '',
                // Data tabel manual (Array kosong untuk diisi user)
                quran: [{ materi: '', ayat: '', nilai: '' }], 
                doa: [{ materi: '', nilai: '' }],
                hadits: [{ materi: '', nilai: '' }],
                catatan: ''
            });

            // Load Data saat Login
            useEffect(() => {
                window.fb.onAuthStateChanged(window.auth, (u) => {
                    setUser(u);
                    if(u) {
                        setSettings({
                            tpa: localStorage.getItem('tpaName')||'', 
                            teacher: localStorage.getItem('teacherName')||'',
                            logo: localStorage.getItem('appLogo')||''
                        });
                        // Load Santri
                        window.fb.onSnapshot(window.fb.query(window.fb.collection(window.db, 'users', u.uid, 'students'), window.fb.orderBy('name')), snap => 
                            setStudents(snap.docs.map(d=>({id:d.id, ...d.data()})))
                        );
                        // Load Riwayat Harian (Opsional, buat history aja)
                        window.fb.onSnapshot(window.fb.query(window.fb.collection(window.db, 'users', u.uid, 'records'), window.fb.orderBy('created_at', 'desc')), snap => 
                            setRecords(snap.docs.map(d=>({id:d.id, ...d.data()})))
                        );
                    }
                });
            }, []);

            // --- FUNGSI AUTH & SETTING ---
            const handleLogin = () => window.fb.signInWithPopup(window.auth, new window.fb.GoogleAuthProvider());
            const handleLogout = () => { if(confirm("Keluar?")) window.fb.signOut(window.auth); }
            const saveSettings = () => { localStorage.setItem('tpaName', settings.tpa); localStorage.setItem('teacherName', settings.teacher); localStorage.setItem('appLogo', settings.logo); alert("Pengaturan Tersimpan!"); }
            const handleLogoUpload = (e) => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onloadend = () => setSettings({...settings, logo: r.result}); r.readAsDataURL(f); } }

            // --- FUNGSI DATA SANTRI ---
            const [newStudent, setNewStudent] = useState('');
            const saveStudent = async () => { if(newStudent){ await window.fb.addDoc(window.fb.collection(window.db, 'users', user.uid, 'students'), {name: newStudent}); setNewStudent(''); } }
            const deleteStudent = async (id) => { if(confirm("Hapus santri?")) await window.fb.deleteDoc(window.fb.doc(window.db, 'users', user.uid, 'students', id)); }

            // --- FUNGSI INPUT HARIAN (Sederhana) ---
            const [dailyForm, setDailyForm] = useState({ studentId: '', materi: '', nilai: 'Lancar' });
            const saveDaily = async (e) => {
                e.preventDefault();
                if(!dailyForm.studentId) return alert("Pilih Santri");
                const sName = students.find(s=>s.id===dailyForm.studentId)?.name;
                await window.fb.addDoc(window.fb.collection(window.db, 'users', user.uid, 'records'), { ...dailyForm, studentName: sName, created_at: window.fb.serverTimestamp(), date: new Date().toISOString().split('T')[0] });
                alert("Tersimpan!");
            }

            // --- FUNGSI RAPOR MANUAL ---
            // Helper untuk menambah/hapus baris di form rapor
            const addRow = (section) => setRaporForm({...raporForm, [section]: [...raporForm[section], { materi: '', ayat: '', nilai: '' }]});
            const removeRow = (section, idx) => {
                const newRows = raporForm[section].filter((_, i) => i !== idx);
                setRaporForm({...raporForm, [section]: newRows});
            }
            const updateRow = (section, idx, field, value) => {
                const newRows = [...raporForm[section]];
                newRows[idx][field] = value;
                setRaporForm({...raporForm, [section]: newRows});
            }

            // GENERATE PDF RAPOR
            const generatePDF = () => {
                if(!raporForm.studentId) return alert("Pilih Santri Dulu!");
                const doc = new window.jspdf.jsPDF();
                const studentName = students.find(s=>s.id === raporForm.studentId)?.name || "Santri";
                
                // KOP SURAT
                if(settings.logo) { try { doc.addImage(settings.logo, 'JPEG', 15, 10, 20, 20); } catch(e){} }
                doc.setFontSize(16); doc.setFont("helvetica", "bold");
                doc.text("LAPORAN PERKEMBANGAN TAHFIDZ", 105, 20, { align: "center" });
                doc.setFontSize(12); doc.setFont("helvetica", "normal");
                doc.text(settings.tpa || "TPA / Rumah Qur'an", 105, 27, { align: "center" });
                doc.line(15, 32, 195, 32);

                // IDENTITAS
                doc.setFontSize(10);
                doc.text(`Nama Santri : ${studentName}`, 15, 42);
                doc.text(`Periode     : ${raporForm.periode || '-'}`, 15, 48);
                doc.text(`Penguji     : ${settings.teacher || '-'}`, 130, 42);

                let currentY = 55;

                // TABEL 1: AL-QURAN
                doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.setTextColor(0, 100, 0);
                doc.text("A. HAFALAN AL-QUR'AN", 15, currentY);
                currentY += 2;
                doc.autoTable({
                    startY: currentY,
                    head: [['No', 'Surat / Materi', 'Ayat / Hal', 'Nilai / Keterangan']],
                    body: raporForm.quran.map((r, i) => [i+1, r.materi, r.ayat, r.nilai]),
                    theme: 'grid',
                    headStyles: { fillColor: [22, 163, 74] }, // Warna Hijau
                    columnStyles: { 0: {cellWidth: 10}, 2: {cellWidth: 30}, 3: {cellWidth: 50} },
                    margin: { left: 15, right: 15 }
                });
                currentY = doc.lastAutoTable.finalY + 10;

                // TABEL 2: DOA
                doc.text("B. HAFALAN DOA HARIAN", 15, currentY);
                currentY += 2;
                doc.autoTable({
                    startY: currentY,
                    head: [['No', 'Nama Doa', 'Nilai / Keterangan']],
                    body: raporForm.doa.map((r, i) => [i+1, r.materi, r.nilai]),
                    theme: 'grid',
                    headStyles: { fillColor: [234, 179, 8] }, // Warna Kuning/Orange
                    columnStyles: { 0: {cellWidth: 10}, 2: {cellWidth: 50} },
                    margin: { left: 15, right: 15 }
                });
                currentY = doc.lastAutoTable.finalY + 10;

                // TABEL 3: HADITS
                doc.text("C. HAFALAN HADITS", 15, currentY);
                currentY += 2;
                doc.autoTable({
                    startY: currentY,
                    head: [['No', 'Tema Hadits', 'Nilai / Keterangan']],
                    body: raporForm.hadits.map((r, i) => [i+1, r.materi, r.nilai]),
                    theme: 'grid',
                    headStyles: { fillColor: [59, 130, 246] }, // Warna Biru
                    columnStyles: { 0: {cellWidth: 10}, 2: {cellWidth: 50} },
                    margin: { left: 15, right: 15 }
                });
                currentY = doc.lastAutoTable.finalY + 10;

                // CATATAN
                // Cek jika halaman tidak cukup
                if(currentY > 250) { doc.addPage(); currentY = 20; }
                
                doc.setFillColor(240, 240, 240);
                doc.rect(15, currentY, 180, 20, 'F');
                doc.setFont("helvetica", "bold"); doc.setTextColor(0,0,0);
                doc.text("Catatan Ustadz/Ustadzah:", 17, currentY + 6);
                doc.setFont("helvetica", "normal");
                doc.text(raporForm.catatan || "-", 17, currentY + 12);

                // TANDA TANGAN
                const signY = currentY + 35;
                doc.text("Mengetahui,", 15, signY);
                doc.text("Orang Tua Santri", 15, signY + 6);
                doc.text("( ........................... )", 15, signY + 25);

                doc.text(settings.tpa ? "Kepala TPA" : "Guru Pembimbing", 140, signY + 6);
                doc.text(`( ${settings.teacher || "..........................."} )`, 140, signY + 25);

                doc.save(`Rapor_${studentName}.pdf`);
            }


            // --- UI RENDER ---
            if(!user) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100">
                    <button onClick={handleLogin} className="bg-white p-6 rounded-xl shadow-xl flex items-center gap-3 font-bold text-blue-600 hover:scale-105 transition">
                        üîë Login Google Untuk Mulai
                    </button>
                </div>
            );

            return (
                <div className="max-w-4xl mx-auto min-h-screen bg-white shadow-2xl flex flex-col">
                    {/* HEADER */}
                    <div className="bg-slate-900 text-white p-4 flex justify-between items-center sticky top-0 z-50">
                        <div className="flex items-center gap-3 font-bold text-lg">
                            {settings.logo ? <img src={settings.logo} className="w-8 h-8 rounded bg-white"/> : "üìñ"} 
                            App Ngaji
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>setActiveTab('input')} className={`px-3 py-1 rounded ${activeTab==='input'?'bg-blue-600':'hover:bg-slate-700'}`}>Harian</button>
                            <button onClick={()=>setActiveTab('rapor')} className={`px-3 py-1 rounded ${activeTab==='rapor'?'bg-blue-600':'hover:bg-slate-700'}`}>Buat Rapor</button>
                            <button onClick={()=>setActiveTab('settings')} className={`px-3 py-1 rounded ${activeTab==='settings'?'bg-blue-600':'hover:bg-slate-700'}`}>‚öôÔ∏è</button>
                            <button onClick={handleLogout} className="px-3 py-1 bg-red-600 rounded text-xs">Keluar</button>
                        </div>
                    </div>

                    <div className="p-4 flex-1 bg-slate-50 overflow-y-auto">
                        
                        {/* TAB INPUT HARIAN (SIMPLE) */}
                        {activeTab === 'input' && (
                            <div className="animate-fade">
                                <h2 className="font-bold text-xl mb-4 text-slate-700">üìù Input Setoran Harian</h2>
                                <form onSubmit={saveDaily} className="bg-white p-4 rounded-xl shadow-sm border space-y-4">
                                    <select className="w-full border p-2 rounded" value={dailyForm.studentId} onChange={e=>setDailyForm({...dailyForm, studentId:e.target.value})}>
                                        <option value="">-- Pilih Santri --</option>
                                        {students.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                                    </select>
                                    <input placeholder="Materi (Misal: Iqro 2 Hal 5 / An-Naba)" className="w-full border p-2 rounded" value={dailyForm.materi} onChange={e=>setDailyForm({...dailyForm, materi:e.target.value})}/>
                                    <select className="w-full border p-2 rounded" value={dailyForm.nilai} onChange={e=>setDailyForm({...dailyForm, nilai:e.target.value})}>
                                        <option>Lancar</option><option>Ulang</option><option>Belum Lancar</option>
                                    </select>
                                    <button className="w-full bg-blue-600 text-white py-2 rounded font-bold">SIMPAN</button>
                                </form>
                                {/* List Singkat */}
                                <div className="mt-6 space-y-2">
                                    {records.slice(0,5).map(r=>(
                                        <div key={r.id} className="bg-white p-3 rounded border flex justify-between">
                                            <span><b>{r.studentName}</b>: {r.materi}</span>
                                            <span className="text-sm bg-green-100 px-2 rounded text-green-700">{r.nilai}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* TAB PENGATURAN & DATA SANTRI */}
                        {activeTab === 'settings' && (
                            <div className="animate-fade space-y-6">
                                <div className="bg-white p-4 rounded-xl shadow border">
                                    <h3 className="font-bold mb-2">Data Lembaga</h3>
                                    <input type="file" onChange={handleLogoUpload} className="mb-2 text-sm"/>
                                    <input placeholder="Nama TPA" className="w-full border p-2 rounded mb-2" value={settings.tpa} onChange={e=>setSettings({...settings, tpa:e.target.value})}/>
                                    <input placeholder="Nama Guru" className="w-full border p-2 rounded mb-2" value={settings.teacher} onChange={e=>setSettings({...settings, teacher:e.target.value})}/>
                                    <button onClick={saveSettings} className="bg-green-600 text-white px-4 py-2 rounded">Simpan Info</button>
                                </div>
                                <div className="bg-white p-4 rounded-xl shadow border">
                                    <h3 className="font-bold mb-2">Data Santri</h3>
                                    <div className="flex gap-2 mb-4">
                                        <input placeholder="Nama Baru..." className="flex-1 border p-2 rounded" value={newStudent} onChange={e=>setNewStudent(e.target.value)}/>
                                        <button onClick={saveStudent} className="bg-blue-600 text-white px-4 rounded">Tambah</button>
                                    </div>
                                    {students.map(s=>(
                                        <div key={s.id} className="flex justify-between border-b py-2">
                                            <span>{s.name}</span>
                                            <button onClick={()=>deleteStudent(s.id)} className="text-red-500">Hapus</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* TAB RAPOR MANUAL (FITUR UTAMA) */}
                        {activeTab === 'rapor' && (
                            <div className="animate-fade">
                                <h2 className="font-bold text-xl mb-4 text-slate-700 flex items-center gap-2">üéì Buat Rapor Manual</h2>
                                
                                <div className="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                                    {/* Bagian Atas */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">NAMA SANTRI</label>
                                            <select className="w-full border-2 border-blue-100 p-2 rounded-lg font-bold" value={raporForm.studentId} onChange={e=>setRaporForm({...raporForm, studentId:e.target.value})}>
                                                <option value="">-- Pilih Nama --</option>
                                                {students.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">PERIODE / SEMESTER</label>
                                            <input placeholder="Cth: Januari 2026 / Semester 1" className="w-full border p-2 rounded-lg" value={raporForm.periode} onChange={e=>setRaporForm({...raporForm, periode:e.target.value})}/>
                                        </div>
                                    </div>

                                    {/* Tabel Input Manual */}
                                    <div className="space-y-6">
                                        
                                        {/* SECTION QURAN */}
                                        <div className="border rounded-xl p-4 bg-green-50">
                                            <h3 className="font-bold text-green-800 mb-2 flex justify-between">
                                                A. HAFALAN QUR'AN
                                                <button onClick={()=>addRow('quran')} className="text-xs bg-green-200 px-2 py-1 rounded hover:bg-green-300">+ Tambah Baris</button>
                                            </h3>
                                            {raporForm.quran.map((row, idx) => (
                                                <div key={idx} className="flex gap-2 mb-2">
                                                    <input placeholder="Surat (Cth: Al-Fatihah s/d An-Nas)" className="flex-1 border p-1 rounded text-sm" value={row.materi} onChange={e=>updateRow('quran', idx, 'materi', e.target.value)}/>
                                                    <input placeholder="Ayat (Cth: 1-5)" className="w-24 border p-1 rounded text-sm" value={row.ayat} onChange={e=>updateRow('quran', idx, 'ayat', e.target.value)}/>
                                                    <input placeholder="Nilai (Cth: Lancar)" className="w-32 border p-1 rounded text-sm" value={row.nilai} onChange={e=>updateRow('quran', idx, 'nilai', e.target.value)}/>
                                                    {raporForm.quran.length > 1 && <button onClick={()=>removeRow('quran', idx)} className="text-red-400 font-bold">√ó</button>}
                                                </div>
                                            ))}
                                        </div>

                                        {/* SECTION DOA */}
                                        <div className="border rounded-xl p-4 bg-yellow-50">
                                            <h3 className="font-bold text-yellow-800 mb-2 flex justify-between">
                                                B. HAFALAN DOA
                                                <button onClick={()=>addRow('doa')} className="text-xs bg-yellow-200 px-2 py-1 rounded hover:bg-yellow-300">+ Tambah Baris</button>
                                            </h3>
                                            {raporForm.doa.map((row, idx) => (
                                                <div key={idx} className="flex gap-2 mb-2">
                                                    <input placeholder="Nama Doa (Cth: Doa Makan)" className="flex-1 border p-1 rounded text-sm" value={row.materi} onChange={e=>updateRow('doa', idx, 'materi', e.target.value)}/>
                                                    <input placeholder="Nilai (Cth: Baik)" className="w-32 border p-1 rounded text-sm" value={row.nilai} onChange={e=>updateRow('doa', idx, 'nilai', e.target.value)}/>
                                                    {raporForm.doa.length > 1 && <button onClick={()=>removeRow('doa', idx)} className="text-red-400 font-bold">√ó</button>}
                                                </div>
                                            ))}
                                        </div>

                                        {/* SECTION HADITS */}
                                        <div className="border rounded-xl p-4 bg-blue-50">
                                            <h3 className="font-bold text-blue-800 mb-2 flex justify-between">
                                                C. HAFALAN HADITS
                                                <button onClick={()=>addRow('hadits')} className="text-xs bg-blue-200 px-2 py-1 rounded hover:bg-blue-300">+ Tambah Baris</button>
                                            </h3>
                                            {raporForm.hadits.map((row, idx) => (
                                                <div key={idx} className="flex gap-2 mb-2">
                                                    <input placeholder="Tema Hadits (Cth: Kebersihan)" className="flex-1 border p-1 rounded text-sm" value={row.materi} onChange={e=>updateRow('hadits', idx, 'materi', e.target.value)}/>
                                                    <input placeholder="Nilai (Cth: Mumtaz)" className="w-32 border p-1 rounded text-sm" value={row.nilai} onChange={e=>updateRow('hadits', idx, 'nilai', e.target.value)}/>
                                                    {raporForm.hadits.length > 1 && <button onClick={()=>removeRow('hadits', idx)} className="text-red-400 font-bold">√ó</button>}
                                                </div>
                                            ))}
                                        </div>

                                        {/* CATATAN */}
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">CATATAN USTADZ/USTADZAH</label>
                                            <textarea className="w-full border p-2 rounded h-20" placeholder="Tulis pesan untuk orang tua..." value={raporForm.catatan} onChange={e=>setRaporForm({...raporForm, catatan:e.target.value})}/>
                                        </div>

                                        {/* TOMBOL CETAK */}
                                        <button onClick={generatePDF} className="w-full bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-slate-700 flex justify-center items-center gap-2">
                                            üñ®Ô∏è CETAK PDF SEKARANG
                                        </button>

                                    </div>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
